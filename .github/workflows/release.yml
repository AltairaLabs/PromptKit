name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string
      phase:
        description: 'Release phase'
        required: true
        type: choice
        options:
          - full
          - libs-only
          - tools-only
        default: full
      skip_tests:
        description: 'Skip running tests'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    
    - name: Validate version format
      id: validate
      env:
        INPUT_VERSION: ${{ inputs.version }}
      run: |
        VERSION="$INPUT_VERSION"
        
        # Ensure version starts with 'v'
        if [[ ! $VERSION =~ ^v ]]; then
          VERSION="v$VERSION"
        fi
        
        # Validate semver format
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "::error::Version must be in format v1.0.0"
          exit 1
        fi
        
        # Check if version already exists
        if git tag -l | grep -q "^$VERSION$\|^runtime/$VERSION$"; then
          echo "::error::Version $VERSION already exists"
          exit 1
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ“ Version $VERSION is valid and available"
    
    - name: Setup Go
      if: ${{ !inputs.skip_tests }}
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Run tests
      if: ${{ !inputs.skip_tests }}
      run: |
        echo "Running full test suite..."
        make test
        make test-race
        echo "âœ“ All tests passed"

  tag-dependencies:
    name: Tag Libraries
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.phase == 'full' || inputs.phase == 'dependencies-only' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Tag runtime
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        echo "Tagging runtime/$VERSION"
        git tag -a "runtime/$VERSION" -m "Release runtime $VERSION"
        git push origin "runtime/$VERSION"
        echo "âœ“ Tagged runtime/$VERSION"
    
    - name: Tag pkg
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        echo "Tagging pkg/$VERSION"
        git tag -a "pkg/$VERSION" -m "Release pkg $VERSION"
        git push origin "pkg/$VERSION"
        echo "âœ“ Tagged pkg/$VERSION"
    
    - name: Tag sdk
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        echo "Tagging sdk/$VERSION"
        git tag -a "sdk/$VERSION" -m "Release sdk $VERSION"
        git push origin "sdk/$VERSION"
        echo "âœ“ Tagged sdk/$VERSION"
    
    - name: Wait for Go proxy
      if: ${{ inputs.phase == 'full' }}
      run: |
        echo "â³ Waiting 10 minutes for Go proxy to cache libraries..."
        sleep 600
    
    - name: Verify on Go proxy
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        echo "Checking runtime module..."
        for i in {1..5}; do
          if curl -f -s "https://proxy.golang.org/github.com/!altaira!labs/!prompt!kit/runtime/@v/$VERSION.info"; then
            echo "âœ“ runtime/$VERSION is available on Go proxy"
            break
          fi
          echo "Attempt $i/5 failed, waiting 30s..."
          sleep 30
        done
        
        echo "Checking pkg module..."
        for i in {1..5}; do
          if curl -f -s "https://proxy.golang.org/github.com/!altaira!labs/!prompt!kit/pkg/@v/$VERSION.info"; then
            echo "âœ“ pkg/$VERSION is available on Go proxy"
            break
          fi
          echo "Attempt $i/5 failed, waiting 30s..."
          sleep 30
        done
        
        echo "Checking sdk module..."
        for i in {1..5}; do
          if curl -f -s "https://proxy.golang.org/github.com/!altaira!labs/!prompt!kit/sdk/@v/$VERSION.info"; then
            echo "âœ“ sdk/$VERSION is available on Go proxy"
            break
          fi
          echo "Attempt $i/5 failed, waiting 30s..."
          sleep 30
        done

  update-tools:
    name: Update and Tag Tools
    runs-on: ubuntu-latest
    needs: [validate, tag-dependencies]
    if: ${{ always() && (inputs.phase == 'full' || inputs.phase == 'tools-only') && needs.validate.result == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    
    - name: Setup Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Create release branch
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        BRANCH="release/tools/$VERSION"
        git checkout -b "$BRANCH"
        echo "âœ“ Created branch $BRANCH"
    
    - name: Update arena dependencies
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        echo "Updating tools/arena..."
        cd tools/arena
        
        go mod edit -dropreplace=github.com/AltairaLabs/PromptKit/runtime
        go mod edit -dropreplace=github.com/AltairaLabs/PromptKit/pkg
        go get "github.com/AltairaLabs/PromptKit/runtime@$VERSION"
        go get "github.com/AltairaLabs/PromptKit/pkg@$VERSION"
        go mod tidy
        
        echo "Building arena..."
        go build -v ./...
        
        cd ../..
        echo "âœ“ Updated arena"
    
    - name: Update packc dependencies
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        echo "Updating tools/packc..."
        cd tools/packc
        
        go mod edit -dropreplace=github.com/AltairaLabs/PromptKit/runtime
        go mod edit -dropreplace=github.com/AltairaLabs/PromptKit/pkg
        go get "github.com/AltairaLabs/PromptKit/runtime@$VERSION"
        go get "github.com/AltairaLabs/PromptKit/pkg@$VERSION"
        go mod tidy
        
        echo "Building packc..."
        go build -v ./...
        
        cd ../..
        echo "âœ“ Updated packc"
    
    - name: Commit changes
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        git add tools/arena/go.mod tools/arena/go.sum
        git add tools/packc/go.mod tools/packc/go.sum
        git commit -m "release: update tools to $VERSION"
        
        BRANCH="release/tools/$VERSION"
        git push origin "$BRANCH"
        echo "âœ“ Pushed $BRANCH"
    
    - name: Tag arena
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        git tag -a "tools/arena/$VERSION" -m "Release arena $VERSION"
        git push origin "tools/arena/$VERSION"
        echo "âœ“ Tagged tools/arena/$VERSION"
    
    - name: Tag packc
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        git tag -a "tools/packc/$VERSION" -m "Release packc $VERSION"
        git push origin "tools/packc/$VERSION"
        echo "âœ“ Tagged tools/packc/$VERSION"
    
    - name: Wait and verify installation
      env:
        VERSION: ${{ needs.validate.outputs.version }}
      run: |
        echo "â³ Waiting 5 minutes for Go proxy..."
        sleep 300
        
        echo "Testing arena installation..."
        if go install "github.com/AltairaLabs/PromptKit/tools/arena/cmd/promptarena@$VERSION"; then
          echo "âœ“ Arena installation successful"
        else
          echo "âš  Arena installation needs more time"
        fi
        
        echo "Testing packc installation..."
        if go install "github.com/AltairaLabs/PromptKit/tools/packc@$VERSION"; then
          echo "âœ“ Packc installation successful"
        else
          echo "âš  Packc installation needs more time"
        fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, update-tools]
    if: ${{ inputs.phase == 'full' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0
    
    - name: Setup Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@9ed2f89a662bf1735a48bc8557fd212fa902bebf # v6.1.0
      with:
        distribution: goreleaser
        version: latest
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts summary
      run: |
        echo "## ðŸ“¦ Release Artifacts Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "GoReleaser has created:" >> $GITHUB_STEP_SUMMARY
        echo "- Multi-platform binaries (Linux, macOS, Windows)" >> $GITHUB_STEP_SUMMARY
        echo "- Archives (tar.gz, zip)" >> $GITHUB_STEP_SUMMARY
        echo "- Checksums for verification" >> $GITHUB_STEP_SUMMARY
        echo "- Automated changelog" >> $GITHUB_STEP_SUMMARY
        echo "- Draft GitHub release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Review at:** https://github.com/${{ github.repository }}/releases" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [validate, tag-dependencies, update-tools, create-release]
    if: always()
    
    steps:
    - name: Generate summary
      env:
        VERSION: ${{ needs.validate.outputs.version }}
        VALIDATION_RESULT: ${{ needs.validate.result }}
        DEPENDENCIES_RESULT: ${{ needs.tag-dependencies.result }}
        TOOLS_RESULT: ${{ needs.update-tools.result }}
        RELEASE_RESULT: ${{ needs.create-release.result }}
        GITHUB_REPO: ${{ github.repository }}
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # Release $VERSION Summary
        
        ## Status
        
        - Validation: $VALIDATION_RESULT
        - Dependencies: $DEPENDENCIES_RESULT
        - Tools: $TOOLS_RESULT
        - GitHub Release: $RELEASE_RESULT
        
        ## Installation
        
        **SDK Library:**
        \`\`\`bash
        go get github.com/AltairaLabs/PromptKit/sdk@$VERSION
        \`\`\`
        
        **CLI Tools:**
        \`\`\`bash
        go install github.com/AltairaLabs/PromptKit/tools/arena/cmd/promptarena@$VERSION
        go install github.com/AltairaLabs/PromptKit/tools/packc@$VERSION
        \`\`\`
        
        ## Next Steps
        
        1. Review and publish the [draft release](https://github.com/$GITHUB_REPO/releases)
        2. Update README.md with new version
        3. Announce the release
        4. Restore replace directives on main branch (if needed)
        
        ## Verification
        
        Test the release:
        \`\`\`bash
        promptarena --version
        packc --version
        \`\`\`
        EOF
