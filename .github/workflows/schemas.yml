name: Schema Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'pkg/config/**'
      - 'tools/schema-gen/**'
      - 'schemas/**/*.json'
      - 'examples/**/*.yaml'
      - '.github/workflows/schemas.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'pkg/config/**'
      - 'tools/schema-gen/**'
      - 'schemas/**/*.json'
      - 'examples/**/*.yaml'
      - '.github/workflows/schemas.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Set up Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: '1.25.1'
    
    - name: Install dependencies
      run: |
        go work sync
        cd tools/schema-gen && go mod download
    
    - name: Check if schemas are up to date
      run: make schemas-check
    
    - name: Generate schemas (if check failed)
      if: failure()
      run: |
        echo "::error::Schemas are out of date. Run 'make schemas' locally and commit the changes."
        make schemas
        echo "Expected schemas:"
        find schemas -name "*.json" -type f
    
    - name: Test schema generator
      run: |
        echo "Running schema generator tests..."
        cd tools/schema-gen
        go test -v -coverprofile=coverage.out ./...
        go tool cover -func=coverage.out | grep total
  
  validate-with-cli:
    name: Validate with promptarena CLI
    runs-on: ubuntu-latest
    needs: validate-schemas
    
    env:
      PROMPTKIT_SCHEMA_SOURCE: local
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Set up Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: '1.25.1'
    
    - name: Install dependencies
      run: go work sync
    
    - name: Generate schemas
      run: make schemas
    
    - name: Build promptarena
      run: make build-arena
    
    - name: Validate example arena configs
      run: |
        echo "Validating Arena configs with promptarena validate..."
        ERRORS=0
        
        for file in $(find examples -name "config.arena.yaml" -o -name "*.arena.yaml" -o -name "arena.yaml"); do
          echo "Validating $file..."
          if ./bin/promptarena validate "$file" --schema-only; then
            echo "âœ“ $file passed"
          else
            echo "âœ— $file failed"
            ERRORS=$((ERRORS + 1))
          fi
        done
        
        if [ $ERRORS -gt 0 ]; then
          echo "::error::$ERRORS arena config(s) failed CLI validation"
          exit 1
        fi

  # Note: ajv validation removed as it's redundant with promptarena CLI validation above
  # The promptarena validate command provides authoritative validation since it uses
  # the same code that will load these configs at runtime
  
  validate-examples-disabled:
    name: Validate Example Configs with ajv (DISABLED - redundant)
    if: false  # Disabled - promptarena CLI validation is authoritative
    runs-on: ubuntu-latest
    needs: validate-schemas
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Set up Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: '1.25.1'
    
    - name: Set up Node.js
      uses: actions/setup-node@65d868f8d4d85d7d4abb7de0875cde3fcc8798f5 # v6.1.0
      with:
        node-version: '20'
    
    - name: Install ajv-cli for JSON schema validation
      run: npm install -g ajv-cli ajv-formats
    
    - name: Generate schemas
      run: make schemas
    
    - name: Validate Arena configs
      run: |
        echo "Validating Arena configuration files..."
        SCHEMA="schemas/v1alpha1/arena.json"
        ERRORS=0
        
        for file in $(find examples -name "config.arena.yaml" -o -name "*.arena.yaml" -o -name "arena.yaml"); do
          echo "Checking $file..."
          if ajv validate -s "$SCHEMA" -d "$file" --strict=false 2>&1; then
            echo "âœ“ $file is valid"
          else
            echo "âœ— $file is invalid"
            ERRORS=$((ERRORS + 1))
          fi
        done
        
        if [ $ERRORS -gt 0 ]; then
          echo "::error::$ERRORS Arena config file(s) failed validation"
          exit 1
        fi
    
    - name: Validate Scenario configs
      run: |
        echo "Validating Scenario configuration files..."
        SCHEMA="schemas/v1alpha1/scenario.json"
        ERRORS=0
        
        for file in $(find examples -name "*.scenario.yaml" -o -path "*/scenarios/*.yaml"); do
          echo "Checking $file..."
          if ajv validate -s "$SCHEMA" -d "$file" --strict=false 2>&1; then
            echo "âœ“ $file is valid"
          else
            echo "âœ— $file is invalid"
            ERRORS=$((ERRORS + 1))
          fi
        done
        
        if [ $ERRORS -gt 0 ]; then
          echo "::error::$ERRORS Scenario config file(s) failed validation"
          exit 1
        fi
    
    - name: Validate Provider configs
      run: |
        echo "Validating Provider configuration files..."
        SCHEMA="schemas/v1alpha1/provider.json"
        ERRORS=0
        
        for file in $(find examples -name "*.provider.yaml" -o -path "*/providers/*.yaml"); do
          echo "Checking $file..."
          if ajv validate -s "$SCHEMA" -d "$file" --strict=false 2>&1; then
            echo "âœ“ $file is valid"
          else
            echo "âœ— $file is invalid"
            ERRORS=$((ERRORS + 1))
          fi
        done
        
        if [ $ERRORS -gt 0 ]; then
          echo "::error::$ERRORS Provider config file(s) failed validation"
          exit 1
        fi
    
    - name: Generate validation summary
      if: always()
      run: |
        echo "# ðŸ“‹ Schema Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Configuration Files Validated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Arena | $(find examples -name "arena.yaml" -o -name "*arena*.yaml" | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Scenarios | $(find examples -path "*/scenarios/*.yaml" | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Providers | $(find examples -path "*/providers/*.yaml" | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Schema Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find schemas -name "*.json" -type f >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
