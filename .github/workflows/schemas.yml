name: Schema Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'pkg/config/**'
      - 'tools/schema-gen/**'
      - 'schemas/**/*.json'
      - 'examples/**/*.yaml'
      - '.github/workflows/schemas.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'pkg/config/**'
      - 'tools/schema-gen/**'
      - 'schemas/**/*.json'
      - 'examples/**/*.yaml'
      - '.github/workflows/schemas.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Set up Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: '1.25.1'
    
    - name: Install dependencies
      run: |
        go work sync
        cd tools/schema-gen && go mod download
    
    - name: Check if schemas are up to date
      run: make schemas-check
    
    - name: Generate schemas (if check failed)
      if: failure()
      run: |
        echo "::error::Schemas are out of date. Run 'make schemas' locally and commit the changes."
        make schemas
        echo "Expected schemas:"
        find schemas -name "*.json" -type f
    
    - name: Test schema generator
      run: |
        echo "Running schema generator tests..."
        cd tools/schema-gen
        go test -v -coverprofile=coverage.out ./...
        go tool cover -func=coverage.out | grep total
  
  validate-with-cli:
    name: Validate with promptarena CLI
    runs-on: ubuntu-latest
    needs: validate-schemas
    
    env:
      PROMPTKIT_SCHEMA_SOURCE: local
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Set up Go
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version: '1.25.1'
    
    - name: Install dependencies
      run: go work sync
    
    - name: Generate schemas
      run: make schemas
    
    - name: Build promptarena
      run: make build-arena
    
    - name: Validate example arena configs
      run: |
        echo "Validating Arena configs with promptarena validate..."
        ERRORS=0
        
        for file in $(find examples -name "config.arena.yaml" -o -name "*.arena.yaml" -o -name "arena.yaml"); do
          echo "Validating $file..."
          if ./bin/promptarena validate "$file" --schema-only; then
            echo "✓ $file passed"
          else
            echo "✗ $file failed"
            ERRORS=$((ERRORS + 1))
          fi
        done
        
        if [ $ERRORS -gt 0 ]; then
          echo "::error::$ERRORS arena config(s) failed CLI validation"
          exit 1
        fi