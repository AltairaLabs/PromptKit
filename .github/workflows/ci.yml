name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/docs.yml'
      - '.github/workflows/release.yml'
      - '.github/workflows/release-test.yml'
      - '.github/workflows/npm-publish.yml'
      - '.github/CODEOWNERS'
      - 'scripts/setup-branch-protection.sh'
      - '.goreleaser.yml'
      - 'npm/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'  
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/docs.yml'
      - '.github/workflows/release.yml'
      - '.github/workflows/release-test.yml'
      - '.github/workflows/npm-publish.yml'
      - '.github/CODEOWNERS'
      - 'scripts/setup-branch-protection.sh'
      - '.goreleaser.yml'
      - 'npm/**'

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.25.1']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: Install dependencies
      run: make install
    
    - name: Generate schemas for tests
      run: make schemas-copy
    
    - name: Install gotestsum
      run: go install gotest.tools/gotestsum@latest
    
    - name: Run tests with coverage and race detector
      run: |
        echo "Running tests with coverage and race detection..."
        mkdir -p test-results
        # Run tests with race detector and generate coverage + JUnit output
        gotestsum --junitfile test-results/coverage-runtime.xml --format testname -- -race -coverprofile=runtime/runtime-coverage.out ./runtime/...
        gotestsum --junitfile test-results/coverage-sdk.xml --format testname -- -race -coverprofile=sdk/sdk-coverage.out ./sdk/...
        gotestsum --junitfile test-results/coverage-arena.xml --format testname -- -race -coverprofile=tools/arena/arena-coverage.out ./tools/arena/...
        gotestsum --junitfile test-results/coverage-pkg.xml --format testname -- -race -coverprofile=pkg/pkg-coverage.out ./pkg/...
        gotestsum --junitfile test-results/coverage-packc.xml --format testname -- -race -coverprofile=tools/packc/packc-coverage.out ./tools/packc/...
        gotestsum --junitfile test-results/coverage-inspect-state.xml --format testname -- -race -coverprofile=tools/inspect-state/inspect-state-coverage.out ./tools/inspect-state/...
        gotestsum --junitfile test-results/coverage-schema-gen.xml --format testname -- -race -coverprofile=tools/schema-gen/schema-gen-coverage.out ./tools/schema-gen/...
        
        # Merge coverage files
        echo "mode: set" > coverage.out
        grep -h -v "^mode:" runtime/runtime-coverage.out sdk/sdk-coverage.out tools/arena/arena-coverage.out pkg/pkg-coverage.out tools/packc/packc-coverage.out tools/inspect-state/inspect-state-coverage.out tools/schema-gen/schema-gen-coverage.out >> coverage.out 2>/dev/null || true
        echo "Coverage report generated: coverage.out"
    
    - name: Publish Test Results  
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Test Results
        path: 'test-results/*.xml'
        reporter: java-junit
        fail-on-error: false
    
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: coverage-report
        path: |
          coverage.out
          runtime/runtime-coverage.out
          sdk/sdk-coverage.out
          tools/arena/arena-coverage.out
          pkg/pkg-coverage.out
          tools/packc/packc-coverage.out
          tools/inspect-state/inspect-state-coverage.out
          tools/schema-gen/schema-gen-coverage.out
        retention-days: 5
  
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis
    
    - name: Download coverage artifacts
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        name: coverage-report
    
    - name: Verify coverage file
      run: |
        echo "Checking for coverage files..."
        ls -la *.out 2>/dev/null || echo "No .out files in root"
        ls -la coverage.out 2>/dev/null || echo "coverage.out not found"
        echo "Coverage file size:"
        wc -l coverage.out 2>/dev/null || echo "Cannot read coverage.out"
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarqube-scan-action@0303d6b62e310685c0e34d0b9cde218036885c4d # v5.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  
  lint:
    name: Lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module:
          - ./runtime
          - ./sdk
          - ./pkg
          - ./tools/arena
          - ./tools/packc
          - ./tools/inspect-state
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0  # Needed for diff-based linting
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
        cache-dependency-path: |
          runtime/go.sum
          sdk/go.sum
          pkg/go.sum
          tools/arena/go.sum
          tools/packc/go.sum
          tools/inspect-state/go.sum
    
    - name: Run golangci-lint in ${{ matrix.module }}
      uses: golangci/golangci-lint-action@v7
      with:
        version: v2.6.0
        working-directory: ${{ matrix.module }}
        args: --issues-exit-code=0
        only-new-issues: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  verify:
    name: Verify (Diff-based Checks)
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0  # Full history needed for diff analysis
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Download coverage artifacts
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        name: coverage-report
    
    - name: Install diff-cover
      run: |
        python3 -m pip install --upgrade pip
        pip3 install diff-cover
    
    - name: Run diff-based coverage check
      run: |
        echo "üìä Checking coverage on changed lines (minimum 80%)..."
        
        # Determine base branch for comparison
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_REF="${{ github.base_ref }}"
        else
          BASE_REF="origin/main"
        fi
        
        echo "Comparing against: $BASE_REF"
        
        # Run diff-cover
        if diff-cover coverage.out \
            --compare-branch="$BASE_REF" \
            --fail-under=80 \
            --diff-filter=AM \
            --html-report coverage-diff.html; then
          echo "‚úì Coverage check passed (‚â•80% on changed lines)"
        else
          echo "‚ùå Coverage is below 80% on changed lines"
          echo "See the coverage-diff.html report for details"
          exit 1
        fi
    
    - name: Upload diff coverage report
      if: always()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: diff-coverage-report
        path: coverage-diff.html
        retention-days: 5
    
    - name: Comment PR with coverage results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Check if diff-cover output exists
          let coverageMessage = '## üìä Diff Coverage Report\n\n';
          
          try {
            // Read the exit code from the previous step
            const coveragePassed = ${{ job.status == 'success' }};
            
            if (coveragePassed) {
              coverageMessage += '‚úÖ **Coverage check passed!**\n\n';
              coverageMessage += 'Changed lines have ‚â•80% test coverage.\n';
            } else {
              coverageMessage += '‚ùå **Coverage check failed**\n\n';
              coverageMessage += 'Some changed lines have <80% test coverage.\n';
              coverageMessage += 'Please add tests for the changed code.\n';
            }
            
            coverageMessage += '\nüìÑ [View detailed coverage report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            
            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageMessage
            });
          } catch (error) {
            console.log('Could not post coverage comment:', error);
          }
  
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Build runtime components
      run: make build
  
  test-arena-mock:
    name: Test Arena with Mock Provider
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Build Arena
      run: make build-arena
    
    - name: Test customer-support example
      run: |
        cd examples/customer-support
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-responses.yaml \
          --scenario customer-support-scenarios \
          --formats json,junit,html,markdown
    
    - name: Test multimodal-basics example
      run: |
        cd examples/multimodal-basics
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-responses.yaml \
          --formats json,junit,html,markdown
    
    - name: Test variables-demo example
      run: |
        cd examples/variables-demo
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-config.yaml \
          --formats json,junit,html,markdown
    
    - name: Verify outputs were generated
      run: |
        EXAMPLES=("customer-support" "multimodal-basics" "variables-demo")
        
        for example in "${EXAMPLES[@]}"; do
          echo "=== Verifying $example ==="
          
          if [ ! -d "examples/$example/out" ]; then
            echo "Error: $example output directory not created"
            exit 1
          fi
          
          if [ ! -f "examples/$example/out/junit.xml" ]; then
            echo "Error: $example junit.xml not created"
            exit 1
          fi
          
          if [ ! -f "examples/$example/out/results.md" ]; then
            echo "Error: $example results.md not created"
            exit 1
          fi
          
          echo "‚úì $example tests completed successfully"
          ls -la examples/$example/out/
          echo ""
        done
    
    - name: Generate Combined Test Summary
      if: always()
      run: |
        echo "# üéØ PromptArena Example Tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Testing multiple examples with mock providers to ensure Arena functionality." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Combine results from all examples
        EXAMPLES=("customer-support" "multimodal-basics" "variables-demo")
        EXAMPLE_NAMES=("Customer Support" "Multimodal Basics" "Variables Demo")
        
        for i in "${!EXAMPLES[@]}"; do
          example="${EXAMPLES[$i]}"
          name="${EXAMPLE_NAMES[$i]}"
          
          echo "## üìä $name" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "examples/$example/out/results.md" ]; then
            # Extract just the overview and results tables (skip the title)
            tail -n +3 "examples/$example/out/results.md" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Results not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "## üìé Download Reports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Complete HTML, JSON, and JUnit reports are available in the following artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-customer-support-reports**" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-multimodal-reports**" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-variables-reports**" >> $GITHUB_STEP_SUMMARY
    
    - name: Publish Customer Support Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Customer Support
        path: examples/customer-support/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Publish Multimodal Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Multimodal Basics
        path: examples/multimodal-basics/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Publish Variables Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Variables Demo
        path: examples/variables-demo/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Upload Customer Support Reports
      if: always()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: arena-customer-support-reports
        path: examples/customer-support/out/
        retention-days: 5
    
    - name: Upload Multimodal Reports
      if: always()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: arena-multimodal-reports
        path: examples/multimodal-basics/out/
        retention-days: 5
    
    - name: Upload Variables Reports
      if: always()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: arena-variables-reports
        path: examples/variables-demo/out/
        retention-days: 5
