name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/docs.yml'
      - '.github/workflows/release.yml'
      - '.github/workflows/release-test.yml'
      - '.github/workflows/npm-publish.yml'
      - '.github/CODEOWNERS'
      - 'scripts/setup-branch-protection.sh'
      - '.goreleaser.yml'
      - 'npm/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'  
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/docs.yml'
      - '.github/workflows/release.yml'
      - '.github/workflows/release-test.yml'
      - '.github/workflows/npm-publish.yml'
      - '.github/CODEOWNERS'
      - 'scripts/setup-branch-protection.sh'
      - '.goreleaser.yml'
      - 'npm/**'

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

env:
  # Prefer local JSON Schemas during CI to avoid stale remote downloads
  PROMPTKIT_SCHEMA_SOURCE: local

jobs:
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    env:
      PROMPTKIT_SCHEMA_SOURCE: local
    strategy:
      matrix:
        go-version: ['1.25.1']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: Install dependencies
      run: make install
    
    - name: Generate schemas for tests
      run: make schemas-copy
    
    - name: Install gotestsum
      run: go install gotest.tools/gotestsum@latest
    
    - name: Run tests with coverage and race detector
      run: |
        echo "Running tests with coverage and race detection..."
        mkdir -p test-results
        # Run tests with race detector and generate coverage + JUnit output
        gotestsum --junitfile test-results/coverage-runtime.xml --format testname -- -race -coverprofile=runtime/runtime-coverage.out ./runtime/...
        gotestsum --junitfile test-results/coverage-sdk.xml --format testname -- -race -coverprofile=sdk/sdk-coverage.out ./sdk/...
        gotestsum --junitfile test-results/coverage-arena.xml --format testname -- -race -coverprofile=tools/arena/arena-coverage.out ./tools/arena/...
        gotestsum --junitfile test-results/coverage-pkg.xml --format testname -- -race -coverprofile=pkg/pkg-coverage.out ./pkg/...
        gotestsum --junitfile test-results/coverage-packc.xml --format testname -- -race -coverprofile=tools/packc/packc-coverage.out ./tools/packc/...
        gotestsum --junitfile test-results/coverage-inspect-state.xml --format testname -- -race -coverprofile=tools/inspect-state/inspect-state-coverage.out ./tools/inspect-state/...
        gotestsum --junitfile test-results/coverage-schema-gen.xml --format testname -- -race -coverprofile=tools/schema-gen/schema-gen-coverage.out ./tools/schema-gen/...
        
        # Merge coverage files
        echo "mode: set" > coverage.out
        grep -h -v "^mode:" runtime/runtime-coverage.out sdk/sdk-coverage.out tools/arena/arena-coverage.out pkg/pkg-coverage.out tools/packc/packc-coverage.out tools/inspect-state/inspect-state-coverage.out tools/schema-gen/schema-gen-coverage.out >> coverage.out 2>/dev/null || true
        echo "Coverage report generated: coverage.out"
    
    - name: Publish Test Results  
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Test Results
        path: 'test-results/*.xml'
        reporter: java-junit
        fail-on-error: false
    
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: coverage-report
        path: |
          coverage.out
          runtime/runtime-coverage.out
          sdk/sdk-coverage.out
          tools/arena/arena-coverage.out
          pkg/pkg-coverage.out
          tools/packc/packc-coverage.out
          tools/inspect-state/inspect-state-coverage.out
          tools/schema-gen/schema-gen-coverage.out
        retention-days: 5
  
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.actor != 'dependabot[bot]'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis
    
    - name: Download coverage artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: coverage-report
    
    - name: Verify coverage file
      run: |
        echo "Checking for coverage files..."
        ls -la *.out 2>/dev/null || echo "No .out files in root"
        ls -la coverage.out 2>/dev/null || echo "coverage.out not found"
        echo "Coverage file size:"
        wc -l coverage.out 2>/dev/null || echo "Cannot read coverage.out"
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    strategy:
      matrix:
        module:
          - ./runtime
          - ./sdk
          - ./pkg
          - ./tools/arena
          - ./tools/packc
          - ./tools/inspect-state
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0  # Needed for diff-based linting
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
        cache-dependency-path: |
          runtime/go.sum
          sdk/go.sum
          pkg/go.sum
          tools/arena/go.sum
          tools/packc/go.sum
          tools/inspect-state/go.sum
    
    - name: Run golangci-lint in ${{ matrix.module }}
      uses: golangci/golangci-lint-action@v9
      with:
        version: v2.6.0
        working-directory: ${{ matrix.module }}
        args: --issues-exit-code=0
        only-new-issues: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Build runtime components
      run: make build
  
  test-arena-mock:
    name: Test Arena with Mock Provider
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    env:
      PROMPTKIT_SCHEMA_SOURCE: local
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Set up Go
      uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
      with:
        go-version: '1.25.1'
    
    - name: Build Arena
      run: make build-arena
    
    - name: Test customer-support example
      run: |
        cd examples/customer-support
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-responses.yaml \
          --scenario customer-support-scenarios \
          --formats json,junit,html,markdown
    
    - name: Test multimodal-basics example
      run: |
        cd examples/multimodal-basics
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-responses.yaml \
          --formats json,junit,html,markdown
    
    - name: Test variables-demo example
      run: |
        cd examples/variables-demo
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-config.yaml \
          --formats json,junit,html,markdown
    
    - name: Test assertions-test example (includes self-play multi-turn)
      run: |
        cd examples/assertions-test
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-responses.yaml \
          --formats json,junit,html,markdown
    
    - name: Test llm-judge example
      run: |
        cd examples/llm-judge
        ../../bin/promptarena run --config config.arena.yaml \
          --formats json,junit,html,markdown
    
    - name: Test guardrails-test example
      run: |
        cd examples/guardrails-test
        ../../bin/promptarena run --config config.arena.yaml \
          --mock-provider \
          --mock-config mock-responses.yaml \
          --formats json,junit,html,markdown
    
    - name: Verify outputs were generated
      run: |
        EXAMPLES=("customer-support" "multimodal-basics" "variables-demo" "assertions-test" "llm-judge" "guardrails-test")
        
        for example in "${EXAMPLES[@]}"; do
          echo "=== Verifying $example ==="
          
          if [ ! -d "examples/$example/out" ]; then
            echo "Error: $example output directory not created"
            exit 1
          fi
          
          if [ ! -f "examples/$example/out/junit.xml" ]; then
            echo "Error: $example junit.xml not created"
            exit 1
          fi
          
          if [ ! -f "examples/$example/out/results.md" ]; then
            echo "Error: $example results.md not created"
            exit 1
          fi
          
          echo "âœ“ $example tests completed successfully"
          ls -la examples/$example/out/
          echo ""
        done
    
    - name: Generate Combined Test Summary
      if: always()
      run: |
        echo "# ðŸŽ¯ PromptArena Example Tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Testing multiple examples with mock providers to ensure Arena functionality." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Combine results from all examples
        EXAMPLES=("customer-support" "multimodal-basics" "variables-demo" "assertions-test" "llm-judge" "guardrails-test")
        EXAMPLE_NAMES=("Customer Support" "Multimodal Basics" "Variables Demo" "Assertions Test" "LLM Judge" "Guardrails Test")
        
        for i in "${!EXAMPLES[@]}"; do
          example="${EXAMPLES[$i]}"
          name="${EXAMPLE_NAMES[$i]}"
          
          echo "## ðŸ“Š $name" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "examples/$example/out/results.md" ]; then
            # Extract just the overview and results tables (skip the title)
            tail -n +3 "examples/$example/out/results.md" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Results not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "## ðŸ“Ž Download Reports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Complete HTML, JSON, and JUnit reports are available in the following artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-customer-support-reports**" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-multimodal-reports**" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-variables-reports**" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-assertions-test-reports**" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-llm-judge-reports**" >> $GITHUB_STEP_SUMMARY
        echo "- **arena-guardrails-reports**" >> $GITHUB_STEP_SUMMARY
    
    - name: Publish Customer Support Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Customer Support
        path: examples/customer-support/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Publish Multimodal Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Multimodal Basics
        path: examples/multimodal-basics/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Publish Variables Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Variables Demo
        path: examples/variables-demo/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Upload Customer Support Reports
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: arena-customer-support-reports
        path: examples/customer-support/out/
        retention-days: 5
    
    - name: Upload Multimodal Reports
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: arena-multimodal-reports
        path: examples/multimodal-basics/out/
        retention-days: 5
    
    - name: Upload Variables Reports
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: arena-variables-reports
        path: examples/variables-demo/out/
        retention-days: 5
    
    - name: Publish LLM Judge Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - LLM Judge
        path: examples/llm-judge/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Upload LLM Judge Reports
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: arena-llm-judge-reports
        path: examples/llm-judge/out/
        retention-days: 5
    
    - name: Publish Guardrails Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Guardrails Test
        path: examples/guardrails-test/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Upload Guardrails Reports
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: arena-guardrails-reports
        path: examples/guardrails-test/out/
        retention-days: 5
    
    - name: Publish Assertions Test Results
      uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
      if: always()
      with:
        name: Arena - Assertions Test
        path: examples/assertions-test/out/junit.xml
        reporter: java-junit
        fail-on-error: true
    
    - name: Upload Assertions Test Reports
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: arena-assertions-test-reports
        path: examples/assertions-test/out/
        retention-days: 5
