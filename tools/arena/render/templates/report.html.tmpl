<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .header-logo {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .summary {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .summary h2 {
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .matrix-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .matrix-section h2 {
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .scenario-group {
            background: white;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .scenario-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: opacity 0.2s;
        }
        
        .scenario-header:hover {
            opacity: 0.9;
        }
        
        .scenario-header .collapse-icon {
            font-size: 1.2rem;
            color: white;
            transition: transform 0.2s;
        }
        
        .scenario-group.collapsed .scenario-header .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .scenario-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .scenario-content {
            padding: 1.5rem;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        
        .scenario-group.collapsed .scenario-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .matrix-table th,
        .matrix-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .matrix-table th {
            background: #4a5568;
            color: white;
            font-weight: 600;
        }
        
        .matrix-table th:first-child {
            background: #2d3748;
        }
        
        .matrix-cell {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
        }
        
        .matrix-cell.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        .matrix-cell.error {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        
        .matrix-cell.empty {
            background: #f7fafc;
            color: #a0aec0;
        }
        
        .scenario-count {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .success-rate {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .cost-info {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .results-section h2 {
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .result-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .result-header {
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .result-header:hover {
            background: #f1f5f9;
        }
        
        .result-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .collapse-icon {
            font-size: 1.2rem;
            color: #718096;
            transition: transform 0.2s;
        }
        
        .result-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .result-title {
            font-weight: 600;
            color: #2d3748;
        }
        
        .result-content {
            padding: 1rem;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        
        .result-card.collapsed .result-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .matrix-cell {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .matrix-cell:hover {
            opacity: 0.8;
        }
        
        .result-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .result-status.success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .result-status.error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .result-content {
            padding: 1rem;
        }
        
        .conversation {
            margin-bottom: 1rem;
        }
        
        .turn {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            position: relative;
        }
        
        .turn.has-failures {
            border: 2px solid #ef4444 !important;
        }
        
        .turn.user {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
        }
        
        .turn.assistant {
            background: #f0fff4;
            border-left: 4px solid #38a169;
        }
        
        .turn.system {
            background: #faf5ff;
            border-left: 4px solid #805ad5;
        }


        
        .turn.tool {
            background: #fff5f0;
            border-left: 4px solid #fd7f28;
        }
        
        .turn-role {
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .turn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .ai-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .ai-icon {
            font-size: 0.9rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .persona-name {
            background: #f3f4f6;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            color: #374151;
        }
        
        .turn-content {
            line-height: 1.5;
        }
        
        .turn-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .turn-content ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .turn-content li {
            margin: 0.25rem 0;
        }
        
        .turn-content p {
            margin: 0.5rem 0;
        }
        
        .turn-content p:first-child {
            margin-top: 0;
        }
        
        .turn-content p:last-child {
            margin-bottom: 0;
        }
        
        .turn-content strong {
            font-weight: 600;
        }
        
        .turn-content em {
            font-style: italic;
        }
        
        .turn-content code {
            background: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .turn-content pre {
            background: #f1f5f9;
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .turn-content pre code {
            background: none;
            padding: 0;
        }
        
        .tool-calls {
            margin-top: 1rem;
        }
        
        .tool-call {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .tool-call:last-child {
            margin-bottom: 0;
        }
        
        .tool-call-header {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }
        
        .tool-call-header:hover {
            opacity: 0.8;
        }
        
        .tool-call-name {
            background: #6366f1;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .tool-call-id {
            color: #718096;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }
        
        .tool-call-toggle {
            margin-left: auto;
            color: #718096;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }
        
        .tool-call-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .tool-call-args {
            background: #f1f5f9;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            display: none;
        }
        
        .tool-call-args.expanded {
            display: block;
        }
        
        .tool-call-args-label {
            font-size: 0.8rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .json-content {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            color: #2d3748;
            line-height: 1.4;
        }
        
        .tool-response {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .tool-response-header {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }
        
        .tool-response-header:hover {
            opacity: 0.8;
        }
        
        .tool-response-name {
            background: #ed8936;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .tool-response-id {
            color: #718096;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }
        
        .tool-response-toggle {
            margin-left: auto;
            color: #718096;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }
        
        .tool-response-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .tool-response-content {
            background: #fffaf0;
            border: 1px solid #fbd38d;
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            display: none;
        }
        
        .tool-response-content.expanded {
            display: block;
        }
        
        .tool-response-label {
            font-size: 0.8rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .raw-request-content {
            display: none;
            margin-top: 0.75rem;
        }

        .raw-request-content.expanded {
            display: block;
        }

        /* DevTools-style right panel */
        :root {
            --devtools-width: 420px;
        }

        .devtools-panel {
            position: fixed;
            top: 0;
            right: calc(-1 * var(--devtools-width));
            width: var(--devtools-width);
            height: 100vh;
            background: #1e1e2e;
            color: #cdd6f4;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: right 0.25s ease;
            display: flex;
            flex-direction: column;
            font-size: 0.85rem;
        }

        .devtools-panel.open {
            right: 0;
        }

        .devtools-panel.resizing {
            transition: none;
            user-select: none;
        }

        body.devtools-open .container {
            margin-right: var(--devtools-width);
            transition: margin-right 0.25s ease;
        }

        body.devtools-resizing .container {
            transition: none;
        }

        .devtools-resize-handle {
            position: absolute;
            left: -3px;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            z-index: 1001;
        }

        .devtools-resize-handle:hover,
        .devtools-resize-handle.active {
            background: #89b4fa;
            opacity: 0.5;
        }

        .devtools-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: #181825;
            border-bottom: 1px solid #313244;
            flex-shrink: 0;
        }

        .devtools-title {
            font-weight: 600;
            font-size: 0.8rem;
            color: #89b4fa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .devtools-turn-label {
            font-size: 0.75rem;
            color: #6c7086;
        }

        .devtools-close {
            background: none;
            border: none;
            color: #6c7086;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            line-height: 1;
        }

        .devtools-close:hover {
            color: #cdd6f4;
            background: #313244;
        }

        .devtools-tabs {
            display: flex;
            background: #181825;
            border-bottom: 1px solid #313244;
            flex-shrink: 0;
        }

        .devtools-tab {
            padding: 0.5rem 1rem;
            font-size: 0.78rem;
            color: #6c7086;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: inherit;
            white-space: nowrap;
        }

        .devtools-tab:hover {
            color: #a6adc8;
        }

        .devtools-tab.active {
            color: #89b4fa;
            border-bottom-color: #89b4fa;
        }

        .devtools-tab-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.2rem;
            height: 1.2rem;
            padding: 0 0.3rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 0.35rem;
            background: #313244;
            color: #a6adc8;
        }

        .devtools-tab.active .devtools-tab-count {
            background: #89b4fa;
            color: #1e1e2e;
        }

        .devtools-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .devtools-tab-content {
            display: none;
            padding: 0.75rem;
        }

        .devtools-tab-content.active {
            display: block;
        }

        .devtools-section {
            margin-bottom: 1rem;
        }

        .devtools-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: #6c7086;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #313244;
        }

        .devtools-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
            border-bottom: 1px solid #313244;
        }

        .devtools-metric-label {
            color: #a6adc8;
        }

        .devtools-metric-value {
            color: #a6e3a1;
            font-family: 'Courier New', monospace;
        }

        .devtools-tool-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .devtools-tool-item {
            padding: 0.35rem 0.5rem;
            border-bottom: 1px solid #313244;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .devtools-tool-item:last-child {
            border-bottom: none;
        }

        .devtools-tool-item:hover {
            background: #313244;
        }

        .devtools-tool-badge {
            display: inline-block;
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .devtools-tool-badge.workflow {
            background: #fab387;
            color: #1e1e2e;
        }

        .devtools-tool-badge.skill {
            background: #89b4fa;
            color: #1e1e2e;
        }

        .devtools-tool-badge.a2a {
            background: #cba6f7;
            color: #1e1e2e;
        }

        .devtools-tool-badge.other {
            background: #6c7086;
            color: #1e1e2e;
        }

        .devtools-json {
            background: #11111b;
            border: 1px solid #313244;
            border-radius: 4px;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.78rem;
            white-space: pre-wrap;
            word-break: break-all;
            color: #cdd6f4;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .devtools-empty {
            color: #585b70;
            font-style: italic;
            padding: 1rem 0;
            text-align: center;
        }

        .inspect-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 4px;
            background: #e0e7ff;
            border: 1px solid #a5b4fc;
            cursor: pointer;
            font-size: 0.75rem;
            color: #4338ca;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .inspect-btn:hover {
            background: #c7d2fe;
            border-color: #818cf8;
        }

        .inspect-btn.active {
            background: #4338ca;
            color: white;
            border-color: #4338ca;
        }

        /* Hidden data containers for devtools */
        .devtools-data {
            display: none;
        }
        
        .turn-error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .error-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .error-details {
            flex: 1;
        }
        
        .error-type {
            font-weight: 600;
            color: #c53030;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .error-message {
            color: #742a2a;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .meta-item {
            text-align: center;
        }
        
        .meta-label {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 0.25rem;
        }
        
        .meta-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        .media-outputs-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .media-outputs-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.75rem;
        }
        
        .media-outputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .media-output-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .media-output-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #cbd5e0;
        }
        
        .media-output-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .media-icon {
            font-size: 1.2rem;
        }
        
        .media-type {
            font-weight: 600;
            font-size: 0.85rem;
            color: #4a5568;
            text-transform: capitalize;
        }
        
        .media-thumbnail {
            margin-bottom: 0.5rem;
            text-align: center;
            background: white;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .media-thumbnail img {
            max-width: 100%;
            max-height: 120px;
            display: block;
            margin: 0 auto;
        }
        
        .media-details {
            font-size: 0.8rem;
        }
        
        .media-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .media-detail-item:last-child {
            border-bottom: none;
        }
        
        .media-detail-label {
            color: #718096;
            font-weight: 500;
        }
        
        .media-detail-value {
            color: #2d3748;
            font-weight: 600;
            text-align: right;
        }
        
        .media-filepath {
            font-family: 'Courier New', monospace;
        }
        
        /* Conversation Assertions Styles */
        .conversation-assertions-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .conversation-assertions-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
        }
        
        .conversation-assertions-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .conversation-assertions-badge.passed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .conversation-assertions-badge.failed {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .conversation-assertions-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
        }
        
        .conversation-assertions-count {
            font-size: 0.8rem;
            color: #718096;
            margin-left: auto;
        }
        
        .conversation-assertions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .conversation-assertions-table thead th {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
        }
        
        .conversation-assertions-table tbody td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            vertical-align: top;
        }
        
        .conversation-assertions-table tbody tr.passed {
            background: #f0fdf4;
        }
        
        .conversation-assertions-table tbody tr.failed {
            background: #fef2f2;
        }
        
        .assertion-index {
            font-weight: 500;
            color: #2d3748;
        }
        
        .assertion-status {
            white-space: nowrap;
        }
        
        .assertion-status .status-icon {
            display: inline-block;
            width: 1.2rem;
            height: 1.2rem;
            line-height: 1.2rem;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .assertion-status .status-icon.passed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .assertion-status .status-icon.failed {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .assertion-message {
            color: #2d3748;
            line-height: 1.4;
        }
        
        .assertion-details {
            font-size: 0.8rem;
        }
        
        .violation-summary {
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 0.25rem;
        }
        
        .violations-list {
            list-style: none;
            padding-left: 0;
            margin: 0.25rem 0;
        }
        
        .violations-list li {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            border-radius: 0.25rem;
        }
        
        .violation-turn {
            font-weight: 600;
            color: #991b1b;
        }
        
        .violation-evidence {
            background: white;
            border: 1px solid #fecaca;
            border-radius: 0.25rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
        }
        
        .assertion-details-json {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }
        
        .validations-section {
            display: none;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        
        .validations-section.expanded {
            display: block;
        }
        
        .validations-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .validation-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .validation-item:last-child {
            margin-bottom: 0;
        }
        
        .validation-item.passed {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }
        
        .validation-item.failed {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }
        
        .validation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .validation-type {
            font-weight: 600;
            font-size: 0.85rem;
            color: #374151;
            font-family: 'Courier New', monospace;
        }
        
        .validation-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .validation-status.passed {
            color: #059669;
        }
        
        .validation-status.failed {
            color: #dc2626;
        }
        
        .validation-icon {
            font-size: 1rem;
        }
        
        .validation-details {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .validation-details-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .validation-details-content {
            font-size: 0.8rem;
            color: #374151;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .validation-message {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .validation-message-icon {
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .validation-message-text {
            font-size: 0.8rem;
            color: #1e40af;
            line-height: 1.4;
        }
        
        .turn-metrics-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: #e0e7ff;
            border: 1px solid #a5b4fc;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #3730a3;
            font-weight: 500;
        }
        
        .validation-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.15rem;
            cursor: pointer;
            padding: 0.15rem 0.35rem;
            border-radius: 3px;
            font-size: 0.7rem;
            transition: background 0.2s;
        }
        
        .validation-badge:hover {
            opacity: 0.8;
        }
        
        .validation-badge.passed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .validation-badge.failed {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-icon {
            font-size: 0.85rem;
        }
        
        .badge-label {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        /* Media Content Styles */
        .media-summary-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        
        .media-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .media-badge.image {
            background: #e6f7ff;
            color: #0066cc;
        }
        
        .media-badge.audio {
            background: #fff0f6;
            color: #c41d7f;
        }
        
        .media-badge.video {
            background: #f6ffed;
            color: #389e0d;
        }
        
        .media-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .media-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .media-item.loaded {
            background: #f0fdf4;
            border-color: #86efac;
        }
        
        .media-item.error {
            background: #fef2f2;
            border-color: #fca5a5;
        }
        
        .media-item.not-loaded {
            background: #fefce8;
            border-color: #fde047;
        }
        
        .media-icon {
            font-size: 1.5rem;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .media-info {
            flex: 1;
            min-width: 0;
        }
        
        .media-type {
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .media-source {
            font-size: 0.875rem;
            color: #1e293b;
            word-break: break-all;
            margin-bottom: 0.25rem;
        }
        
        .media-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .media-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .media-status.loaded {
            color: #16a34a;
        }
        
        .media-status.error {
            color: #dc2626;
        }
        
        .media-status.not-loaded {
            color: #ca8a04;
        }

        /* Audio Player Styles */
        .audio-player {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f1f5f9;
            border-radius: 0.5rem;
        }

        .audio-player audio {
            width: 100%;
            height: 36px;
        }

        .audio-not-playable {
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: #92400e;
            font-style: italic;
        }

        /* A2A Agent tool call styling */
        .tool-call-name.agent {
            background: linear-gradient(135deg, #0d9488, #7c3aed);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
        }

        .tool-response-name.agent {
            background: linear-gradient(135deg, #0d9488, #7c3aed);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
        }

        .agent-icon {
            margin-right: 0.25rem;
        }

        /* Workflow transition tool call styling */
        .tool-call-name.workflow {
            background: linear-gradient(135deg, #d97706, #ea580c);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
        }

        .tool-response-name.workflow {
            background: linear-gradient(135deg, #d97706, #ea580c);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
        }

        .workflow-icon {
            margin-right: 0.25rem;
        }

        /* A2A Agent Cards Section */
        .a2a-agents-section {
            margin-top: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .a2a-agents-header {
            background: linear-gradient(135deg, #f0fdfa, #f5f3ff);
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #1e293b;
            border-bottom: 1px solid #e2e8f0;
        }

        .a2a-agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
            padding: 0.75rem;
        }

        .a2a-agent-card {
            border: 1px solid #e2e8f0;
            border-left: 3px solid #7c3aed;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background: white;
        }

        .a2a-agent-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .a2a-agent-description {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .a2a-skills-list {
            border-top: 1px solid #f1f5f9;
            padding-top: 0.5rem;
        }

        .a2a-skill-item {
            font-size: 0.78rem;
            color: #475569;
            padding: 0.2rem 0;
        }

        .a2a-skill-name {
            font-weight: 500;
        }

        .a2a-skill-desc {
            color: #94a3b8;
        }

        .a2a-skill-tag {
            display: inline-block;
            background: #f1f5f9;
            color: #7c3aed;
            font-size: 0.7rem;
            padding: 0.1rem 0.35rem;
            border-radius: 0.2rem;
            margin-left: 0.25rem;
        }

        /* Validation UI Styles - Deprecated (kept for backwards compatibility) */
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <svg class="header-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128" fill="none">
                <defs>
                    <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#fff" stop-opacity="0.95"/>
                        <stop offset="100%" stop-color="#e0d4ff" stop-opacity="0.9"/>
                    </linearGradient>
                    <linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#e0d4ff" stop-opacity="0.9"/>
                        <stop offset="100%" stop-color="#c4b5fd" stop-opacity="0.85"/>
                    </linearGradient>
                </defs>
                <path d="M24 32 L48 64 L24 96" stroke="url(#lg1)" stroke-width="12" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <rect x="60" y="28" width="44" height="20" rx="4" fill="url(#lg1)"/>
                <rect x="60" y="54" width="44" height="20" rx="4" fill="url(#lg2)"/>
                <rect x="60" y="80" width="44" height="20" rx="4" fill="#c4b5fd" fill-opacity="0.85"/>
            </svg>
            <h1>{{.Title}}</h1>
        </div>
        <div class="subtitle">Generated on {{.GeneratedAt.Format "January 2, 2006 at 3:04 PM"}}</div>
    </div>
    
    <div class="container">
        <div class="summary">
            <h2>Summary</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{.Summary.TotalRuns}}</div>
                    <div class="stat-label">Total Runs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{formatPercent .Summary.SuccessfulRuns .Summary.TotalRuns}}</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{formatCost .Summary.TotalCost}}</div>
                    <div class="stat-label">Total Cost</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{.Summary.TotalTokens}}</div>
                    <div class="stat-label">Total Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{.Summary.AvgLatency}}</div>
                    <div class="stat-label">Avg Latency</div>
                </div>
            </div>
            
            {{if or (gt .Summary.TotalImages 0) (gt .Summary.TotalAudio 0) (gt .Summary.TotalVideo 0)}}
            <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.2rem; color: #2d3748;">Media Content</h3>
            <div class="stats-grid">
                {{if gt .Summary.TotalImages 0}}
                <div class="stat-card">
                    <div class="stat-number">üñºÔ∏è {{.Summary.TotalImages}}</div>
                    <div class="stat-label">Images</div>
                </div>
                {{end}}
                {{if gt .Summary.TotalAudio 0}}
                <div class="stat-card">
                    <div class="stat-number">üéµ {{.Summary.TotalAudio}}</div>
                    <div class="stat-label">Audio Files</div>
                </div>
                {{end}}
                {{if gt .Summary.TotalVideo 0}}
                <div class="stat-card">
                    <div class="stat-number">üé¨ {{.Summary.TotalVideo}}</div>
                    <div class="stat-label">Videos</div>
                </div>
                {{end}}
                <div class="stat-card">
                    <div class="stat-number">‚úÖ {{.Summary.MediaLoadSuccess}}</div>
                    <div class="stat-label">Loaded</div>
                </div>
                {{if gt .Summary.MediaLoadErrors 0}}
                <div class="stat-card">
                    <div class="stat-number" style="color: #dc2626;">‚ùå {{.Summary.MediaLoadErrors}}</div>
                    <div class="stat-label">Errors</div>
                </div>
                {{end}}
                {{if gt .Summary.TotalMediaSize 0}}
                <div class="stat-card">
                    <div class="stat-number">{{formatBytes .Summary.TotalMediaSize}}</div>
                    <div class="stat-label">Total Size</div>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
        
        {{range $scenarioIdx, $scenarioGroup := .ScenarioGroups}}
        <div class="scenario-group" id="scenario-{{$scenarioGroup.ScenarioID}}">
            <div class="scenario-header" onclick="toggleScenario('scenario-{{$scenarioGroup.ScenarioID}}')">
                <span class="collapse-icon">‚ñº</span>
                <div class="scenario-title">{{$scenarioGroup.ScenarioID}}</div>
            </div>
            <div class="scenario-content">
                <div class="matrix-section" style="box-shadow: none; margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: #4a5568;">Provider √ó Region Matrix</h3>
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Provider / Region</th>
                                {{range $scenarioGroup.Regions}}
                                <th>{{.}}</th>
                                {{end}}
                            </tr>
                        </thead>
                        <tbody>
                            {{range $i, $providerRow := $scenarioGroup.Matrix}}
                            <tr>
                                <th>{{index $scenarioGroup.Providers $i}}</th>
                                {{range $providerRow}}
                                <td>
                                    <div class="matrix-cell {{statusClass .Successful .Errors}}" onclick="scrollToResult('{{.Provider}}', '{{.Region}}', '{{$scenarioGroup.ScenarioID}}')">
                                        <div class="scenario-count">{{if gt .Scenarios 0}}‚úì{{else}}-{{end}}</div>
                                        {{if gt .Scenarios 0}}
                                        {{if gt .Errors 0}}
                                        <div class="success-rate">Failed</div>
                                        {{else}}
                                        <div class="success-rate">Success</div>
                                        {{end}}
                                        <div class="cost-info">{{formatCost .Cost}}</div>
                                        {{else}}
                                        <div class="success-rate">No runs</div>
                                        {{end}}
                                    </div>
                                </td>
                                {{end}}
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                
                <div class="results-section" style="box-shadow: none; padding: 0;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: #4a5568;">Results</h3>
                    {{range $resultIdx, $result := $scenarioGroup.Results}}
                    <div class="result-card" id="result-{{$result.ProviderID}}-{{$result.Region}}-{{$result.ScenarioID}}">
                        <div class="result-header" onclick="toggleResult('result-{{$result.ProviderID}}-{{$result.Region}}-{{$result.ScenarioID}}')">
                            <div class="result-header-left">
                                <span class="collapse-icon">‚ñº</span>
                                <div class="result-title">{{$result.ProviderID}} - {{$result.Region}}</div>
                            </div>
                            <div class="result-status {{if $result.Error}}error{{else}}success{{end}}">
                                {{if $result.Error}}Error{{else}}Success{{end}}
                            </div>
                        </div>
                        <div class="result-content">
                            <div class="conversation">
                                {{range $msgIdx, $msg := $result.Messages}}
                                {{$assertions := getAssertions $msg.Meta}}
                                {{$validators := getValidators $msg}}
                                {{$hasAssertions := hasAssertions $msg.Meta}}
                                {{$hasValidators := hasValidators $msg}}
                                {{$hasRawRequest := false}}
                                {{$hasRawResponse := false}}
                                {{$hasAvailableTools := false}}
                                {{$hasToolDescriptors := false}}
                                {{$hasWorkflowState := false}}
                                {{$hasLLMTrace := false}}
                                {{$hasFinishReason := false}}
                                {{$hasPackEvals := false}}
                                {{if $msg.Meta}}
                                    {{$metaMap := $msg.Meta}}
                                    {{if $metaMap}}
                                        {{if index $metaMap "_llm_raw_request"}}
                                            {{$hasRawRequest = true}}
                                        {{end}}
                                        {{if index $metaMap "_llm_raw_response"}}
                                            {{$hasRawResponse = true}}
                                        {{end}}
                                        {{if index $metaMap "_available_tools"}}
                                            {{$hasAvailableTools = true}}
                                        {{end}}
                                        {{if index $metaMap "_tool_descriptors"}}
                                            {{$hasToolDescriptors = true}}
                                        {{end}}
                                        {{if index $metaMap "_workflow_state"}}
                                            {{$hasWorkflowState = true}}
                                        {{end}}
                                        {{if index $metaMap "_llm_trace"}}
                                            {{$hasLLMTrace = true}}
                                        {{end}}
                                        {{if index $metaMap "finish_reason"}}
                                            {{$hasFinishReason = true}}
                                        {{end}}
                                        {{if index $metaMap "pack_evals"}}
                                            {{$hasPackEvals = true}}
                                        {{end}}
                                    {{end}}
                                {{end}}
                                {{$hasDiagnostics := or $hasAvailableTools $hasRawRequest $hasRawResponse $hasLLMTrace $hasPackEvals $hasWorkflowState $msg.CostInfo (not (not $msg.ToolCalls)) (eq $msg.Role "system")}}
                                {{$assertionsFailed := not (assertionsPassed $assertions)}}
                                {{$validatorsFailed := not (validatorsPassed $validators)}}
                                {{$hasFailed := or $assertionsFailed $validatorsFailed}}
                                <div class="turn {{$msg.Role}}{{if $hasFailed}} has-failures{{end}}"{{if $hasDiagnostics}} data-devtools-turn="{{$result.RunID}}-{{$msgIdx}}" style="cursor:pointer;"{{end}}>
                                    <div class="turn-header">
                                        <div class="turn-role">{{$msg.Role}}</div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            {{/* Show persona indicator for self-play user turns */}}
                                            {{if and (eq $msg.Role "user") $result.PersonaID}}
                                            <span class="ai-indicator" title="Self-Play Persona">
                                                <span class="ai-icon">ü§ñ</span>
                                                <span class="persona-name">{{$result.PersonaID}}</span>
                                            </span>
                                            {{end}}
                                            {{if or $msg.LatencyMs $msg.CostInfo}}
                                            <span class="turn-metrics-badge" title="Turn {{add $msgIdx 1}} metrics">
                                                {{if $msg.LatencyMs}}‚è±Ô∏è {{$msg.LatencyMs}}ms{{end}}
                                                {{if $msg.CostInfo}}
                                                {{if $msg.LatencyMs}} | {{end}}üéØ {{$msg.CostInfo.InputTokens}}‚Üí{{$msg.CostInfo.OutputTokens}} | üí∞ {{formatCost $msg.CostInfo.TotalCost}}
                                                {{end}}
                                            </span>
                                            {{end}}
                                            {{if $hasDiagnostics}}
                                            <span class="inspect-btn" onclick="openDevTools('{{$result.RunID}}-{{$msgIdx}}')" title="Inspect turn diagnostics">‚öô</span>
                                            {{end}}
                                            {{if $hasAssertions}}
                                            <span class="validation-badge {{if assertionsPassed $assertions}}passed{{else}}failed{{end}}" 
                                                  onclick="toggleValidations('assertions-{{$result.RunID}}-{{$msgIdx}}')" 
                                                  title="Click to {{if assertionsPassed $assertions}}view{{else}}review{{end}} assertions">
                                                <span class="badge-icon">{{if assertionsPassed $assertions}}‚úì{{else}}‚úó{{end}}</span>
                                                <span class="badge-label">A</span>
                                            </span>
                                            {{end}}
                                            {{if $hasValidators}}
                                            <span class="validation-badge {{if validatorsPassed $validators}}passed{{else}}failed{{end}}" 
                                                  onclick="toggleValidations('validators-{{$result.RunID}}-{{$msgIdx}}')" 
                                                  title="Click to {{if validatorsPassed $validators}}view{{else}}review{{end}} validators">
                                                <span class="badge-icon">{{if validatorsPassed $validators}}‚úì{{else}}‚úó{{end}}</span>
                                                <span class="badge-label">V</span>
                                            </span>
                                            {{end}}
                                        </div>
                                    </div>
                                    
                                    {{if $hasAssertions}}
                                    <div class="validations-section" id="assertions-{{$result.RunID}}-{{$msgIdx}}">
                                        <div class="validations-header">Assertions</div>
                                        {{if hasAssertionResults $assertions}}
                                        {{/* New format: iterate over results array */}}
                                        {{range $assertion := getAssertionResults $assertions}}
                                        <div class="validation-item {{if getOK $assertion}}passed{{else}}failed{{end}}">
                                            <div class="validation-header">
                                                <div class="validation-type">{{getAssertionType $assertion}}</div>
                                                <div class="validation-status {{if getOK $assertion}}passed{{else}}failed{{end}}">
                                                    <span class="validation-icon">{{if getOK $assertion}}‚úì{{else}}‚úó{{end}}</span>
                                                    {{if getOK $assertion}}Passed{{else}}Failed{{end}}
                                                </div>
                                            </div>
                                            {{$message := getMessage $assertion}}
                                            {{if $message}}
                                            <div class="validation-message">
                                                <div class="validation-message-icon">‚ÑπÔ∏è</div>
                                                <div class="validation-message-text">{{$message}}</div>
                                            </div>
                                            {{end}}
                                            {{$details := getDetails $assertion}}
                                            {{if $details}}
                                            <div class="validation-details">
                                                <div class="validation-details-label">Details</div>
                                                <div class="validation-details-content">{{prettyJSON $details}}</div>
                                            </div>
                                            {{end}}
                                        </div>
                                        {{end}}
                                        {{else}}
                                        {{/* Legacy format: iterate over map */}}
                                        {{range $name, $assertion := $assertions}}
                                        <div class="validation-item {{if getOK $assertion}}passed{{else}}failed{{end}}">
                                            <div class="validation-header">
                                                <div class="validation-type">{{$name}}</div>
                                                <div class="validation-status {{if getOK $assertion}}passed{{else}}failed{{end}}">
                                                    <span class="validation-icon">{{if getOK $assertion}}‚úì{{else}}‚úó{{end}}</span>
                                                    {{if getOK $assertion}}Passed{{else}}Failed{{end}}
                                                </div>
                                            </div>
                                            {{$message := getMessage $assertion}}
                                            {{if $message}}
                                            <div class="validation-message">
                                                <div class="validation-message-icon">‚ÑπÔ∏è</div>
                                                <div class="validation-message-text">{{$message}}</div>
                                            </div>
                                            {{end}}
                                            {{$details := getDetails $assertion}}
                                            {{if $details}}
                                            <div class="validation-details">
                                                <div class="validation-details-label">Details</div>
                                                <div class="validation-details-content">{{prettyJSON $details}}</div>
                                            </div>
                                            {{end}}
                                        </div>
                                        {{end}}
                                        {{end}}
                                    </div>
                                    {{end}}
                                    
                                    {{if $hasValidators}}
                                    <div class="validations-section" id="validators-{{$result.RunID}}-{{$msgIdx}}">
                                        <div class="validations-header">Validators</div>
                                        {{range $name, $validator := $validators}}
                                        <div class="validation-item {{if getOK $validator}}passed{{else}}failed{{end}}">
                                            <div class="validation-header">
                                                <div class="validation-type">{{$name}}</div>
                                                <div class="validation-status {{if getOK $validator}}passed{{else}}failed{{end}}">
                                                    <span class="validation-icon">{{if getOK $validator}}‚úì{{else}}‚úó{{end}}</span>
                                                    {{if getOK $validator}}Passed{{else}}Failed{{end}}
                                                </div>
                                            </div>
                                            {{$details := getDetails $validator}}
                                            {{if $details}}
                                            <div class="validation-details">
                                                <div class="validation-details-label">Details</div>
                                                <div class="validation-details-content">{{prettyJSON $details}}</div>
                                            </div>
                                            {{end}}
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                    
                                    {{if ne $msg.Role "tool"}}
                                    <div class="turn-content">{{renderMessageContent $msg}}</div>
                                    {{end}}
                                    {{if $msg.ToolCalls}}
                                    <div class="tool-calls">
                                        {{range $toolIdx, $toolCall := $msg.ToolCalls}}
                                        <div class="tool-call">
                                            <div class="tool-call-header" onclick="toggleToolContent(this)">
                                                <span class="tool-call-name{{if isAgentTool $toolCall.Name}} agent{{else if isWorkflowTool $toolCall.Name}} workflow{{end}}">{{if isAgentTool $toolCall.Name}}<span class="agent-icon">ü§ñ</span>{{else if isWorkflowTool $toolCall.Name}}<span class="workflow-icon">‚ö°</span>{{end}}{{$toolCall.Name}}</span>
                                                <span class="tool-call-id">{{$toolCall.ID}}</span>
                                                <span class="tool-call-toggle">‚ñ∂</span>
                                            </div>
                                            {{if $toolCall.Args}}
                                            <div class="tool-call-args">
                                                <div class="tool-call-args-label">Arguments:</div>
                                                <div class="json-content">{{prettyJSON $toolCall.Args}}</div>
                                            </div>
                                            {{end}}
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                    {{/* Hidden data containers for DevTools panel */}}
                                    {{if $hasDiagnostics}}
                                    <div class="devtools-data" id="devtools-data-{{$result.RunID}}-{{$msgIdx}}"
                                         data-role="{{$msg.Role}}"
                                         data-turn="{{add $msgIdx 1}}"
                                         data-provider="{{$result.ProviderID}}"
                                         data-scenario="{{$result.ScenarioID}}"
                                         {{if $msg.Timestamp}}data-timestamp="{{$msg.Timestamp}}"{{end}}
                                         {{if $hasFinishReason}}data-finish-reason="{{index $msg.Meta "finish_reason"}}"{{end}}>
                                        {{if $msg.CostInfo}}
                                        <div data-devtools="metrics">
                                            <div class="devtools-metric"><span class="devtools-metric-label">Latency</span><span class="devtools-metric-value">{{$msg.LatencyMs}}ms</span></div>
                                            <div class="devtools-metric"><span class="devtools-metric-label">Input Tokens</span><span class="devtools-metric-value">{{$msg.CostInfo.InputTokens}}</span></div>
                                            <div class="devtools-metric"><span class="devtools-metric-label">Output Tokens</span><span class="devtools-metric-value">{{$msg.CostInfo.OutputTokens}}</span></div>
                                            {{if $msg.CostInfo.CachedTokens}}
                                            <div class="devtools-metric"><span class="devtools-metric-label">Cached Tokens</span><span class="devtools-metric-value">{{$msg.CostInfo.CachedTokens}}</span></div>
                                            {{end}}
                                            <div class="devtools-metric"><span class="devtools-metric-label">Input Cost</span><span class="devtools-metric-value">{{formatCost $msg.CostInfo.InputCostUSD}}</span></div>
                                            <div class="devtools-metric"><span class="devtools-metric-label">Output Cost</span><span class="devtools-metric-value">{{formatCost $msg.CostInfo.OutputCostUSD}}</span></div>
                                            {{if $msg.CostInfo.CachedCostUSD}}
                                            <div class="devtools-metric"><span class="devtools-metric-label">Cache Savings</span><span class="devtools-metric-value">{{formatCost $msg.CostInfo.CachedCostUSD}}</span></div>
                                            {{end}}
                                            <div class="devtools-metric"><span class="devtools-metric-label">Total Cost</span><span class="devtools-metric-value">{{formatCost $msg.CostInfo.TotalCost}}</span></div>
                                        </div>
                                        {{end}}
                                        {{if $hasAvailableTools}}
                                        <div data-devtools="tools">{{prettyJSON (index $msg.Meta "_available_tools")}}</div>
                                        {{end}}
                                        {{if $hasToolDescriptors}}
                                        <div data-devtools="tooldescriptors">{{prettyJSON (index $msg.Meta "_tool_descriptors")}}</div>
                                        {{end}}
                                        {{if $hasWorkflowState}}
                                        <div data-devtools="workflow">{{prettyJSON (index $msg.Meta "_workflow_state")}}</div>
                                        {{end}}
                                        {{if $msg.ToolCalls}}
                                        <div data-devtools="toolcalls">{{prettyJSON $msg.ToolCalls}}</div>
                                        {{end}}
                                        {{if eq $msg.Role "system"}}
                                        <div data-devtools="systemprompt">{{$msg.Content}}</div>
                                        {{end}}
                                        {{if $hasRawRequest}}
                                        <div data-devtools="request">{{prettyJSON (index $msg.Meta "_llm_raw_request")}}</div>
                                        {{end}}
                                        {{if $hasRawResponse}}
                                        <div data-devtools="response">{{prettyJSON (index $msg.Meta "_llm_raw_response")}}</div>
                                        {{end}}
                                        {{if $hasLLMTrace}}
                                        <div data-devtools="trace">{{prettyJSON (index $msg.Meta "_llm_trace")}}</div>
                                        {{end}}
                                        {{if $hasPackEvals}}
                                        <div data-devtools="evals">{{prettyJSON (index $msg.Meta "pack_evals")}}</div>
                                        {{end}}
                                        {{if $msg.Validations}}
                                        <div data-devtools="validations">{{prettyJSON $msg.Validations}}</div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                    {{if eq $msg.Role "tool"}}
                                    <div class="tool-response">
                                        <div class="tool-response-header" onclick="toggleToolResponse(this)">
                                            {{if $msg.ToolResult}}
                                            <span class="tool-response-name{{if isAgentTool $msg.ToolResult.Name}} agent{{else if isWorkflowTool $msg.ToolResult.Name}} workflow{{end}}">{{if isAgentTool $msg.ToolResult.Name}}<span class="agent-icon">ü§ñ</span>{{else if isWorkflowTool $msg.ToolResult.Name}}<span class="workflow-icon">‚ö°</span>{{end}}{{$msg.ToolResult.Name}}</span>
                                            <span class="tool-response-id">{{$msg.ToolResult.ID}}</span>
                                            {{else}}
                                            <span class="tool-response-name">Tool Response</span>
                                            {{end}}
                                            <span class="tool-response-toggle">‚ñ∂</span>
                                        </div>
                                        <div class="tool-response-content">
                                            <div class="tool-response-label">Response:</div>
                                            <div class="json-content">{{prettyJSON $msg.Content}}</div>
                                        </div>
                                    </div>
                                    {{if $msg.ToolResult}}
                                    {{if $msg.ToolResult.Error}}
                                    <div class="turn-error">
                                        <div class="error-icon">‚ö†Ô∏è</div>
                                        <div class="error-details">
                                            <div class="error-type">Tool Execution Failed</div>
                                            <div class="error-message">{{$msg.ToolResult.Error}}</div>
                                        </div>
                                    </div>
                                    {{end}}
                                    {{end}}
                                    {{end}}
                                </div>
                                {{end}}
                            </div>
                            
                            <div class="metadata">
                                <div class="meta-item">
                                    <div class="meta-label">Provider</div>
                                    <div class="meta-value">{{$result.ProviderID}}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">Region</div>
                                    <div class="meta-value">{{$result.Region}}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">Duration</div>
                                    <div class="meta-value">{{formatDuration $result.Duration}}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">Total Cost</div>
                                    <div class="meta-value">{{formatCost $result.Cost.TotalCost}}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">Tokens</div>
                                    <div class="meta-value">{{$result.Cost.InputTokens}}+{{$result.Cost.OutputTokens}}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">Turns</div>
                                    <div class="meta-value">{{len $result.Messages}}</div>
                                </div>
                            </div>
                            
                            {{if hasA2AAgents $result}}
                            {{renderA2AAgentCards $result.A2AAgents}}
                            {{end}}

                            {{if hasMediaOutputs $result}}
                            {{renderMediaOutputs $result.MediaOutputs}}
                            {{end}}
                            
                            {{if hasConversationAssertions $result}}
                            {{renderConversationAssertions (getConversationAssertionResults $result)}}
                            {{end}}
                            
                            {{if $result.Error}}
                            <div class="error-message">
                                <strong>Error:</strong> {{$result.Error}}
                            </div>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
        
        <!-- Legacy matrix (deprecated) -->
        <div class="matrix-section" style="display: none;">
            <h2>Provider √ó Region Matrix (Legacy)</h2>
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th>Provider / Region</th>
                        {{range .Regions}}
                        <th>{{.}}</th>
                        {{end}}
                    </tr>
                </thead>
                <tbody>
                    {{range $i, $providerRow := .Matrix}}
                    <tr>
                        <th>{{index $.Providers $i}}</th>
                        {{range $providerRow}}
                        <td>
                            <div class="matrix-cell {{statusClass .Successful .Errors}}">
                                <div class="scenario-count">{{.Scenarios}}</div>
                                {{if gt .Scenarios 0}}
                                <div class="success-rate">{{formatPercent .Successful .Scenarios}} success</div>
                                <div class="cost-info">{{formatCost .Cost}}</div>
                                {{else}}
                                <div class="success-rate">No runs</div>
                                {{end}}
                            </div>
                        </td>
                        {{end}}
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        
        <div class="results-section" style="display: none;">
            <h2>Individual Results (Legacy)</h2>
            <h2>Individual Results (Legacy)</h2>
            {{range $resultIdx, $result := .Results}}
            <div class="result-card" id="legacy-{{$result.ProviderID}}-{{$result.Region}}-{{$result.ScenarioID}}">
                <div class="result-header" onclick="toggleResult('legacy-{{$result.ProviderID}}-{{$result.Region}}-{{$result.ScenarioID}}')">
                    <div class="result-header-left">
                        <span class="collapse-icon">‚ñº</span>
                        <div class="result-title">{{$result.RunID}}</div>
                    </div>
                    <div class="result-status {{if $result.Error}}error{{else}}success{{end}}">
                        {{if $result.Error}}Error{{else}}Success{{end}}
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <!-- DevTools Panel -->
    <div class="devtools-panel" id="devtools-panel">
        <div class="devtools-resize-handle" id="devtools-resize-handle"></div>
        <div class="devtools-header">
            <div>
                <div class="devtools-title">Turn Inspector</div>
                <div class="devtools-turn-label" id="devtools-turn-label"></div>
            </div>
            <button class="devtools-close" onclick="closeDevTools()" title="Close (Esc)">&times;</button>
        </div>
        <div class="devtools-tabs" id="devtools-tabs"></div>
        <div class="devtools-body" id="devtools-body"></div>
    </div>

    <script>
        let currentDevToolsTurnId = null;

        function openDevTools(turnId) {
            var panel = document.getElementById('devtools-panel');
            var data = document.getElementById('devtools-data-' + turnId);
            if (!data) return;

            // Deactivate previous inspect button
            if (currentDevToolsTurnId) {
                var prevBtn = document.querySelector('.inspect-btn.active');
                if (prevBtn) prevBtn.classList.remove('active');
            }

            currentDevToolsTurnId = turnId;

            // Activate this inspect button
            var turn = data.closest('.turn');
            var btn = turn ? turn.querySelector('.inspect-btn') : null;
            if (btn) btn.classList.add('active');

            // Read data attributes for header
            var role = data.getAttribute('data-role') || 'turn';
            var turnNum = data.getAttribute('data-turn') || '';
            var provider = data.getAttribute('data-provider') || '';
            var scenario = data.getAttribute('data-scenario') || '';
            var timestamp = data.getAttribute('data-timestamp') || '';
            var finishReason = data.getAttribute('data-finish-reason') || '';

            document.getElementById('devtools-turn-label').textContent =
                role.toUpperCase() + ' #' + turnNum + (provider ? ' | ' + provider : '');

            // Gather available data elements
            var metricsEl = data.querySelector('[data-devtools="metrics"]');
            var toolsEl = data.querySelector('[data-devtools="tools"]');
            var toolDescsEl = data.querySelector('[data-devtools="tooldescriptors"]');
            var toolcallsEl = data.querySelector('[data-devtools="toolcalls"]');
            var workflowEl = data.querySelector('[data-devtools="workflow"]');
            var promptEl = data.querySelector('[data-devtools="systemprompt"]');
            var requestEl = data.querySelector('[data-devtools="request"]');
            var responseEl = data.querySelector('[data-devtools="response"]');
            var traceEl = data.querySelector('[data-devtools="trace"]');
            var evalsEl = data.querySelector('[data-devtools="evals"]');
            var validationsEl = data.querySelector('[data-devtools="validations"]');

            // Build tabs dynamically based on available data
            var tabs = [];

            // Info tab ‚Äî always present (shows context about the turn)
            tabs.push({ id: 'info', label: 'Info', icon: '‚ÑπÔ∏è' });

            if (workflowEl) tabs.push({ id: 'workflow', label: 'Workflow', icon: '‚ö°' });
            if (metricsEl) tabs.push({ id: 'metrics', label: 'Metrics', icon: 'üìä' });

            if (toolsEl || toolcallsEl) {
                var toolCount = 0;
                if (toolsEl) {
                    try { var p = JSON.parse(toolsEl.textContent); toolCount = Array.isArray(p) ? p.length : 0; } catch(e) {}
                }
                tabs.push({ id: 'tools', label: 'Tools', icon: 'üîß', count: toolCount });
            }

            if (promptEl) tabs.push({ id: 'prompt', label: 'Prompt', icon: 'üìù' });
            if (requestEl) tabs.push({ id: 'request', label: 'Request', icon: 'üì°' });
            if (responseEl) tabs.push({ id: 'response', label: 'Response', icon: 'üì•' });
            if (traceEl) tabs.push({ id: 'trace', label: 'Trace', icon: 'üîç' });
            if (evalsEl) tabs.push({ id: 'evals', label: 'Evals', icon: 'üß™' });
            if (validationsEl) tabs.push({ id: 'validations', label: 'Validators', icon: '‚úì' });

            // Build tab bar
            var tabsContainer = document.getElementById('devtools-tabs');
            tabsContainer.innerHTML = tabs.map(function(t, i) {
                return '<button class="devtools-tab' + (i === 0 ? ' active' : '') + '" data-tab="' + t.id + '" onclick="switchDevToolsTab(\'' + t.id + '\')">' +
                    t.icon + ' ' + t.label +
                    (t.count ? '<span class="devtools-tab-count">' + t.count + '</span>' : '') +
                    '</button>';
            }).join('');

            // Build tab content
            var body = document.getElementById('devtools-body');
            var html = '';
            var firstTab = tabs[0].id;

            // --- Info tab ---
            html += '<div class="devtools-tab-content' + (firstTab === 'info' ? ' active' : '') + '" data-tab-content="info">';
            html += '<div class="devtools-section"><div class="devtools-section-title">Turn Context</div>';
            html += '<div class="devtools-metric"><span class="devtools-metric-label">Role</span><span class="devtools-metric-value">' + role + '</span></div>';
            html += '<div class="devtools-metric"><span class="devtools-metric-label">Turn #</span><span class="devtools-metric-value">' + turnNum + '</span></div>';
            if (provider) html += '<div class="devtools-metric"><span class="devtools-metric-label">Provider</span><span class="devtools-metric-value">' + provider + '</span></div>';
            if (scenario) html += '<div class="devtools-metric"><span class="devtools-metric-label">Scenario</span><span class="devtools-metric-value">' + scenario + '</span></div>';
            if (timestamp) html += '<div class="devtools-metric"><span class="devtools-metric-label">Timestamp</span><span class="devtools-metric-value">' + timestamp + '</span></div>';
            if (finishReason) html += '<div class="devtools-metric"><span class="devtools-metric-label">Finish Reason</span><span class="devtools-metric-value">' + finishReason + '</span></div>';
            // Quick summary of what's in this turn
            var summary = [];
            if (workflowEl) summary.push('workflow');
            if (metricsEl) summary.push('metrics');
            if (toolsEl) summary.push('tool descriptors');
            if (toolcallsEl) summary.push('tool calls');
            if (requestEl) summary.push('raw request');
            if (responseEl) summary.push('raw response');
            if (traceEl) summary.push('LLM trace');
            if (evalsEl) summary.push('evals');
            if (validationsEl) summary.push('validations');
            if (promptEl) summary.push('system prompt');
            html += '</div>';
            if (summary.length > 0) {
                html += '<div class="devtools-section"><div class="devtools-section-title">Available Data</div>';
                html += '<div style="display:flex;flex-wrap:wrap;gap:0.3rem;">';
                summary.forEach(function(s) {
                    html += '<span style="background:#313244;color:#cdd6f4;padding:0.15rem 0.5rem;border-radius:10px;font-size:0.72rem;">' + s + '</span>';
                });
                html += '</div></div>';
            }
            html += '</div>';

            // --- Workflow tab ---
            if (workflowEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'workflow' ? ' active' : '') + '" data-tab-content="workflow">';
                try {
                    var wfData = JSON.parse(workflowEl.textContent);
                    // Transition banner (if this is a post-transition system prompt)
                    if (wfData.previous_state && wfData.transition) {
                        html += '<div class="devtools-section"><div class="devtools-section-title">Transition</div>';
                        html += '<div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.25rem;">';
                        html += '<span style="background:#45475a;color:#cdd6f4;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.8rem;">' + escapeHtml(wfData.previous_state) + '</span>';
                        html += '<span style="color:#fab387;font-weight:700;">‚Üí</span>';
                        html += '<span style="background:#fab387;color:#1e1e2e;padding:0.2rem 0.5rem;border-radius:4px;font-weight:700;font-size:0.8rem;">' + escapeHtml(wfData.current_state) + '</span>';
                        html += '</div>';
                        html += '<div style="color:#6c7086;font-size:0.75rem;">via event: <span style="color:#89b4fa;font-family:monospace;">' + escapeHtml(wfData.transition) + '</span></div>';
                        html += '</div>';
                    }

                    // Current state header
                    html += '<div class="devtools-section"><div class="devtools-section-title">Current State</div>';
                    html += '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">';
                    html += '<span style="background:#fab387;color:#1e1e2e;padding:0.2rem 0.6rem;border-radius:4px;font-weight:700;font-size:0.85rem;">' + escapeHtml(wfData.current_state || '') + '</span>';
                    if (wfData.terminal) html += '<span style="background:#f38ba8;color:#1e1e2e;padding:0.15rem 0.4rem;border-radius:3px;font-size:0.7rem;font-weight:600;">TERMINAL</span>';
                    html += '</div>';
                    if (wfData.description) {
                        html += '<div style="color:#a6adc8;font-size:0.82rem;margin-bottom:0.5rem;line-height:1.4;">' + escapeHtml(wfData.description) + '</div>';
                    }
                    if (wfData.prompt_task) {
                        html += '<div class="devtools-metric"><span class="devtools-metric-label">Prompt Task</span><span class="devtools-metric-value">' + escapeHtml(wfData.prompt_task) + '</span></div>';
                    }
                    html += '</div>';

                    // Available events / transitions
                    if (wfData.available_events) {
                        html += '<div class="devtools-section"><div class="devtools-section-title">Available Transitions</div>';
                        var events = wfData.available_events;
                        for (var ev in events) {
                            if (events.hasOwnProperty(ev)) {
                                html += '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0;border-bottom:1px solid #313244;">';
                                html += '<span style="color:#89b4fa;font-family:monospace;font-size:0.8rem;font-weight:600;">' + escapeHtml(ev) + '</span>';
                                html += '<span style="color:#585b70;">‚Üí</span>';
                                html += '<span style="color:#a6e3a1;font-family:monospace;font-size:0.8rem;">' + escapeHtml(events[ev]) + '</span>';
                                html += '</div>';
                            }
                        }
                        html += '</div>';
                    }

                    // All states overview (collapsible)
                    if (wfData.all_states) {
                        html += '<div class="devtools-section"><div class="devtools-section-title" style="cursor:pointer;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">All States ‚ñ∏</div>';
                        html += '<div style="display:none;">';
                        var states = wfData.all_states;
                        for (var sName in states) {
                            if (!states.hasOwnProperty(sName)) continue;
                            var s = states[sName];
                            var isCurrent = sName === wfData.current_state;
                            html += '<div style="padding:0.5rem;margin-bottom:0.5rem;border:1px solid ' + (isCurrent ? '#fab387' : '#313244') + ';border-radius:4px;' + (isCurrent ? 'background:#2a2a3d;' : '') + '">';
                            html += '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem;">';
                            html += '<span style="font-weight:600;color:' + (isCurrent ? '#fab387' : '#cdd6f4') + ';font-size:0.82rem;">' + escapeHtml(sName) + '</span>';
                            if (s.terminal) html += '<span style="background:#45475a;color:#a6adc8;padding:0.1rem 0.3rem;border-radius:3px;font-size:0.6rem;">terminal</span>';
                            if (isCurrent) html += '<span style="background:#fab387;color:#1e1e2e;padding:0.1rem 0.3rem;border-radius:3px;font-size:0.6rem;font-weight:600;">current</span>';
                            html += '</div>';
                            if (s.description) html += '<div style="color:#6c7086;font-size:0.75rem;margin-bottom:0.25rem;">' + escapeHtml(s.description) + '</div>';
                            if (s.prompt_task) html += '<div style="color:#585b70;font-size:0.72rem;">prompt: ' + escapeHtml(s.prompt_task) + '</div>';
                            if (s.events) {
                                for (var e in s.events) {
                                    if (s.events.hasOwnProperty(e)) {
                                        html += '<div style="color:#585b70;font-size:0.72rem;padding-left:0.5rem;">‚Üí ' + escapeHtml(e) + ' ‚Üí ' + escapeHtml(s.events[e]) + '</div>';
                                    }
                                }
                            }
                            html += '</div>';
                        }
                        html += '</div></div>';
                    }
                } catch(e) {
                    html += '<div class="devtools-section"><div class="devtools-json">' + escapeHtml(workflowEl.textContent) + '</div></div>';
                }
                html += '</div>';
            }

            // --- Metrics tab ---
            if (metricsEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'metrics' ? ' active' : '') + '" data-tab-content="metrics">';
                html += '<div class="devtools-section"><div class="devtools-section-title">Performance</div>';
                html += metricsEl.innerHTML;
                html += '</div></div>';
            }

            // --- Tools tab ---
            if (toolsEl || toolcallsEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'tools' ? ' active' : '') + '" data-tab-content="tools">';

                // Parse tool descriptors if available (has name + description)
                var toolDescMap = {};
                var toolSchemaMap = {};
                if (toolDescsEl) {
                    try {
                        var descs = JSON.parse(toolDescsEl.textContent);
                        if (Array.isArray(descs)) {
                            descs.forEach(function(d) {
                                if (d.name) {
                                    toolDescMap[d.name] = d.description || '';
                                    if (d.input_schema) toolSchemaMap[d.name] = d.input_schema;
                                }
                            });
                        }
                    } catch(e) {}
                }

                // Available tool descriptors
                if (toolsEl) {
                    html += '<div class="devtools-section"><div class="devtools-section-title">Available Tools</div>';
                    try {
                        var toolList = JSON.parse(toolsEl.textContent);
                        if (Array.isArray(toolList) && toolList.length > 0) {
                            html += '<ul class="devtools-tool-list">';
                            toolList.forEach(function(name) {
                                var badge = 'other', badgeLabel = 'tool';
                                if (name.startsWith('workflow__')) { badge = 'workflow'; badgeLabel = 'wf'; }
                                else if (name.startsWith('skill__')) { badge = 'skill'; badgeLabel = 'skill'; }
                                else if (name.startsWith('a2a__')) { badge = 'a2a'; badgeLabel = 'a2a'; }
                                else if (name.startsWith('mcp__')) { badge = 'a2a'; badgeLabel = 'mcp'; }
                                else if (name.startsWith('memory__')) { badge = 'skill'; badgeLabel = 'mem'; }
                                var desc = toolDescMap[name] || '';
                                var schema = toolSchemaMap[name] || null;
                                var hasDetails = desc || schema;
                                html += '<li class="devtools-tool-item" style="flex-direction:column;align-items:flex-start;gap:0.2rem;' + (hasDetails ? 'cursor:pointer;' : '') + '" ' + (hasDetails ? 'onclick="var d=this.querySelector(\'.tool-details\');if(d){d.style.display=d.style.display===\'none\'?\'block\':\'none\';var arrow=this.querySelector(\'.tool-toggle\');if(arrow)arrow.textContent=d.style.display===\'none\'?\'‚ñ∏\':\'‚ñæ\';}"' : '') + '>';
                                html += '<div style="display:flex;align-items:center;gap:0.5rem;width:100%;">';
                                html += '<span class="devtools-tool-badge ' + badge + '">' + badgeLabel + '</span>';
                                html += '<span style="font-family:monospace;font-size:0.8rem;">' + escapeHtml(stripToolNamespace(name)) + '</span>';
                                if (hasDetails) html += '<span class="tool-toggle" style="margin-left:auto;color:#585b70;font-size:0.7rem;">‚ñ∏</span>';
                                html += '</div>';
                                if (hasDetails) {
                                    html += '<div class="tool-details" style="display:none;padding:0.3rem 0 0.1rem 2.2rem;line-height:1.4;width:100%;">';
                                    if (desc) html += '<div style="color:#a6adc8;font-size:0.75rem;white-space:pre-wrap;max-height:150px;overflow-y:auto;margin-bottom:0.4rem;">' + escapeHtml(desc) + '</div>';
                                    if (schema) {
                                        html += '<div style="margin-top:0.2rem;"><span style="color:#6c7086;font-size:0.7rem;font-weight:600;">Input Schema</span>';
                                        html += '<div class="devtools-json" style="margin-top:0.2rem;max-height:300px;">' + escapeHtml(JSON.stringify(schema, null, 2)) + '</div>';
                                        html += '</div>';
                                    }
                                    html += '</div>';
                                }
                                html += '</li>';
                            });
                            html += '</ul>';
                        } else {
                            html += '<div class="devtools-empty">No tools available</div>';
                        }
                    } catch(e) {
                        html += '<div class="devtools-json">' + escapeHtml(toolsEl.textContent) + '</div>';
                    }
                    html += '</div>';
                }

                // Tool calls made in this turn
                if (toolcallsEl) {
                    html += '<div class="devtools-section"><div class="devtools-section-title">Tool Calls Made</div>';
                    try {
                        var calls = JSON.parse(toolcallsEl.textContent);
                        if (Array.isArray(calls) && calls.length > 0) {
                            calls.forEach(function(tc) {
                                var badge = 'other', badgeLabel = 'tool';
                                if (tc.name && tc.name.startsWith('workflow__')) { badge = 'workflow'; badgeLabel = 'wf'; }
                                else if (tc.name && tc.name.startsWith('skill__')) { badge = 'skill'; badgeLabel = 'skill'; }
                                else if (tc.name && tc.name.startsWith('a2a__')) { badge = 'a2a'; badgeLabel = 'a2a'; }
                                else if (tc.name && tc.name.startsWith('mcp__')) { badge = 'a2a'; badgeLabel = 'mcp'; }
                                else if (tc.name && tc.name.startsWith('memory__')) { badge = 'skill'; badgeLabel = 'mem'; }
                                html += '<div style="margin-bottom:0.75rem;border:1px solid #313244;border-radius:4px;overflow:hidden;">';
                                html += '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.5rem;background:#181825;border-bottom:1px solid #313244;">';
                                html += '<span class="devtools-tool-badge ' + badge + '">' + badgeLabel + '</span>';
                                html += '<span style="font-family:monospace;font-size:0.8rem;color:#89b4fa;">' + escapeHtml(stripToolNamespace(tc.name || 'unknown')) + '</span>';
                                if (tc.id) html += '<span style="margin-left:auto;font-size:0.65rem;color:#585b70;">' + tc.id + '</span>';
                                html += '</div>';
                                if (tc.args) {
                                    var argsStr = typeof tc.args === 'string' ? tc.args : JSON.stringify(tc.args, null, 2);
                                    html += '<div class="devtools-json" style="border:none;border-radius:0;max-height:200px;">' + escapeHtml(argsStr) + '</div>';
                                }
                                html += '</div>';
                            });
                        }
                    } catch(e) {
                        html += '<div class="devtools-json">' + escapeHtml(toolcallsEl.textContent) + '</div>';
                    }
                    html += '</div>';
                }

                html += '</div>';
            }

            // --- System Prompt tab ---
            if (promptEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'prompt' ? ' active' : '') + '" data-tab-content="prompt">';
                html += '<div class="devtools-section"><div class="devtools-section-title">System Prompt</div>';
                html += '<div class="devtools-json" style="white-space:pre-wrap;color:#a6e3a1;">' + escapeHtml(promptEl.textContent) + '</div>';
                html += '</div></div>';
            }

            // --- Request tab ---
            if (requestEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'request' ? ' active' : '') + '" data-tab-content="request">';
                html += '<div class="devtools-section"><div class="devtools-section-title">Raw LLM Request</div>';
                html += '<div class="devtools-json">' + escapeHtml(requestEl.textContent) + '</div>';
                html += '</div></div>';
            }

            // --- Response tab ---
            if (responseEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'response' ? ' active' : '') + '" data-tab-content="response">';
                html += '<div class="devtools-section"><div class="devtools-section-title">Raw LLM Response</div>';
                html += '<div class="devtools-json">' + escapeHtml(responseEl.textContent) + '</div>';
                html += '</div></div>';
            }

            // --- Trace tab ---
            if (traceEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'trace' ? ' active' : '') + '" data-tab-content="trace">';
                html += '<div class="devtools-section"><div class="devtools-section-title">LLM Execution Trace</div>';
                html += '<div class="devtools-json">' + escapeHtml(traceEl.textContent) + '</div>';
                html += '</div></div>';
            }

            // --- Evals tab ---
            if (evalsEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'evals' ? ' active' : '') + '" data-tab-content="evals">';
                html += '<div class="devtools-section"><div class="devtools-section-title">Pack Evaluations</div>';
                html += '<div class="devtools-json">' + escapeHtml(evalsEl.textContent) + '</div>';
                html += '</div></div>';
            }

            // --- Validations tab ---
            if (validationsEl) {
                html += '<div class="devtools-tab-content' + (firstTab === 'validations' ? ' active' : '') + '" data-tab-content="validations">';
                html += '<div class="devtools-section"><div class="devtools-section-title">Validation Results</div>';
                html += '<div class="devtools-json">' + escapeHtml(validationsEl.textContent) + '</div>';
                html += '</div></div>';
            }

            body.innerHTML = html;

            // Open the panel
            panel.classList.add('open');
            document.body.classList.add('devtools-open');
        }

        function closeDevTools() {
            var panel = document.getElementById('devtools-panel');
            panel.classList.remove('open');
            document.body.classList.remove('devtools-open');
            var btn = document.querySelector('.inspect-btn.active');
            if (btn) btn.classList.remove('active');
            currentDevToolsTurnId = null;
        }

        function switchDevToolsTab(tabId) {
            document.querySelectorAll('#devtools-tabs .devtools-tab').forEach(function(t) {
                t.classList.toggle('active', t.dataset.tab === tabId);
            });
            document.querySelectorAll('#devtools-body .devtools-tab-content').forEach(function(c) {
                c.classList.toggle('active', c.dataset.tabContent === tabId);
            });
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // Strip namespace prefix from tool names (e.g. workflow__transition ‚Üí transition,
        // a2a__research_agent__search ‚Üí research_agent__search, skill__activate ‚Üí activate)
        function stripToolNamespace(name) {
            var prefixes = ['workflow__', 'skill__', 'a2a__', 'mcp__', 'memory__'];
            for (var i = 0; i < prefixes.length; i++) {
                if (name.startsWith(prefixes[i])) return name.slice(prefixes[i].length);
            }
            return name;
        }

        // Close devtools with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && currentDevToolsTurnId) {
                closeDevTools();
            }
        });

        // Click anywhere on a turn with diagnostics to open/switch devtools
        document.addEventListener('click', function(e) {
            var turn = e.target.closest('[data-devtools-turn]');
            if (!turn) return;
            // Don't intercept clicks on buttons, links, or other interactive elements
            if (e.target.closest('button, a, .validation-badge, .inspect-btn')) return;
            var turnId = turn.getAttribute('data-devtools-turn');
            openDevTools(turnId);
        });

        // Resizable devtools panel
        (function() {
            var handle = document.getElementById('devtools-resize-handle');
            var panel = document.getElementById('devtools-panel');
            var dragging = false;

            handle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                dragging = true;
                handle.classList.add('active');
                panel.classList.add('resizing');
                document.body.classList.add('devtools-resizing');
            });

            document.addEventListener('mousemove', function(e) {
                if (!dragging) return;
                var newWidth = Math.max(280, Math.min(window.innerWidth * 0.8, window.innerWidth - e.clientX));
                document.documentElement.style.setProperty('--devtools-width', newWidth + 'px');
            });

            document.addEventListener('mouseup', function() {
                if (!dragging) return;
                dragging = false;
                handle.classList.remove('active');
                panel.classList.remove('resizing');
                document.body.classList.remove('devtools-resizing');
            });
        })();

        function toggleScenario(scenarioId) {
            const group = document.getElementById(scenarioId);
            group.classList.toggle('collapsed');
        }

        function toggleResult(resultId) {
            const card = document.getElementById(resultId);
            const header = card.querySelector('.result-header');

            card.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        function toggleValidations(validationId) {
            const section = document.getElementById(validationId);
            if (section) {
                section.classList.toggle('expanded');
            }
        }

        function toggleToolContent(header) {
            const toolCall = header.closest('.tool-call');
            const args = toolCall.querySelector('.tool-call-args');
            const toggle = header.querySelector('.tool-call-toggle');
            if (args) {
                args.classList.toggle('expanded');
            }
            if (toggle) {
                toggle.classList.toggle('expanded');
            }
        }

        function toggleToolResponse(header) {
            const response = header.closest('.tool-response');
            const content = response.querySelector('.tool-response-content');
            const toggle = header.querySelector('.tool-response-toggle');
            if (content) {
                content.classList.toggle('expanded');
            }
            if (toggle) {
                toggle.classList.toggle('expanded');
            }
        }

        function scrollToResult(provider, region, scenario) {
            const resultId = 'result-' + provider + '-' + region + '-' + scenario;
            const result = document.getElementById(resultId);
            if (result) {
                result.scrollIntoView({ behavior: 'smooth', block: 'start' });
                if (result.classList.contains('collapsed')) {
                    toggleResult(resultId);
                }
                result.style.boxShadow = '0 0 20px rgba(99, 102, 241, 0.5)';
                setTimeout(function() { result.style.boxShadow = ''; }, 2000);
            }
        }

        function scrollToProvider(provider, region) {
            const results = document.querySelectorAll('.result-card');
            for (const result of results) {
                const id = result.id;
                if (id.startsWith(provider + '-' + region + '-')) {
                    result.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    if (result.classList.contains('collapsed')) {
                        toggleResult(id);
                    }
                    result.style.boxShadow = '0 0 20px rgba(99, 102, 241, 0.5)';
                    setTimeout(function() { result.style.boxShadow = ''; }, 2000);
                    break;
                }
            }
        }
    </script>
</body>
</html>